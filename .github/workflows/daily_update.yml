on:
    workflow_dispatch:
    schedule:
        - cron: '45 * * * *'

name: daily update
permissions:
    contents: write
jobs:
    daily_update:
        runs-on: ubuntu-24.04
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0
            - name: setup Go
              uses: actions/setup-go@v6
              with:
                  go-version: 1.17
            - name: build latest binary
              run: go get -d -v . && CGO_ENABLED=0 go install -v .
            - name: switch to gh-pages branch
              run: |
                  git checkout -b gh-pages origin/gh-pages
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            - name: perform update and push commits (if applicable)
              shell: python
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  import csv, datetime, glob, os, re, subprocess, sys

                  GENERATED  = {
                    "nepal.md":                "---\ntype: location\nlocation: nepal\nmode: commits\n---\n",
                    "nepal_private.md":        "---\ntype: location\nlocation: nepal\nmode: all\n---\n",
                    "nepal_public.md":         "---\ntype: location\nlocation: nepal\nmode: contributions\n---\n",
                    "rank_only/nepal.json":    "---\nlayout: rank_only\nlocation: nepal\n---\n",
                  }

                  subprocess.run("mkdir -p rank_only _data/locations", shell=True, check=True)
                  regenerated = False

                  # generate markdown files
                  expected = ["index.md", "README.md"]
                  expected.append("_data/locations/nepal.yml")
                  for name, content in GENERATED.items():
                    expected.append(name)
                    if not os.path.exists(expected[-1]):
                      regenerated = True
                    with open(expected[-1], "w") as f:
                      f.write(content)

                  # remove files that shouldn't exist
                  for filename in sorted(glob.glob("*.md") + glob.glob("_data/locations/*.yml") + glob.glob("rank_only/*.json")):
                    if filename not in expected:
                      os.remove(filename)
                      regenerated = True

                  if regenerated:
                    to_add = [f for f in expected if os.path.exists(f)]
                    if to_add:
                      subprocess.run(["git", "add"] + to_add, check=True)
                    subprocess.run('git commit -am "regenerate location pages"', shell=True, check=True)

                  # Update Nepal data
                  print("Running: nepal")
                  status = subprocess.run(["most-active-github-users-counter", "--token", os.environ["GITHUB_TOKEN"], "--output", "yaml", "--consider", "1500"], capture_output=True, text=True)
                  if status.returncode == 0:
                    with open("_data/locations/nepal.yml", "w") as f:
                      f.write("page: nepal.html\n%s" % status.stdout)
                    subprocess.run('git add _data/locations/nepal.yml && git commit -m "nepal: updates for %s"' % datetime.date.today().isoformat(), shell=True, check=True)
                    subprocess.run("git push origin gh-pages", shell=True, check=True)
                  else:
                    print("FAILED with exit code %d\n--- stdout ---\n%s\n--- stderr ---\n%s" % (status.returncode, status.stdout, status.stderr))
                    sys.exit(1)
